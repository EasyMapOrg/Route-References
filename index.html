<!DOCTYPE html>
<html>
    <head>
        <title>Route References</title>
        
        <!-- Include meta tag to ensure proper rendering and touch zooming -->
        <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />
        <!-- Include jQuery Mobile stylesheets -->
        <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">
        
        <script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
        
        <script type="text/javascript" src="route.js"></script>
        <script type="text/javascript" src="map_function.js"></script>
        <script type="text/javascript" src="mobile_detect.js"></script>
        
        <link id="css" href="main.css" rel="stylesheet" type="text/css" />
        <link href='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet' />
    </head>
    <body>
        <div id="container">
            <div id="menu">
                <select id="line" onchange="changeline()" class="menu_line"></select>
          
                <select id="route" onchange="createroute()" class="menu_route" disabled>
                        <option value="#">Route</option>
                </select>
                
                <button id="GPX" onclick="downloadGPX()" class="menu_GPX" disabled>Download GPX</button>
                <button id="CSV" onclick="downloadCSV()" class="menu_CSV" disabled>Download CSV</button>
                        
                <button id="reset" onclick="clearroute()" class="menu_RESET">Reset</button>
            </div>
            
            <div id='mouseposition' class='mouseposition'>
                <p class='mouseclick'>Click: <code id='mouseclick'></code><br/></p>
                <p class='mousemove'>Mousemove: <code id='mousemove'></code><br/></p>
            </div>            
            
            <div id='showmap'></div>
            <div id='maptile'>
                <button id='tile' onclick="changetile()">Satellite<br/>Map</button>
            </div>
        </div>
    
        <script>
            //Auto size the screen
            autosize();
            window.addEventListener("resize", autosize);

            //Load lines
            initial_line();
            
            //Mapbox token
            L.mapbox.accessToken = 'pk.eyJ1IjoiaHVhbmdsaXBhbmciLCJhIjoiY2luOGJoeWV3MDU0dDN5bHpmN3ZnNm11dSJ9.1kSYNfN3L-uzTzqmBsIekw';
            
            var map = L.mapbox.map('showmap','' , {
                            minZoom: 2,
                            maxZoom: 18,
                            zoomControl: false
                        }).setView([25.154, 121.377], 4);
            
            L.control.scale({position: 'topleft', maxWidth: 200}).addTo(map);
            //@@
            //Mouse position code starts
            var click = document.getElementById('mouseclick'),
                mousemove = document.getElementById('mousemove');
            
            map.on('mousemove click', function(a){
                
                var lat = Math.abs(a.latlng.lat.toPrecision(9)),
                    lng = Math.abs(a.latlng.wrap(-180, 180).lng.toPrecision(9)),
                    latdeg = parseInt(lat),
                    lngdeg = parseInt(lng),
                    latf = Math.abs(lat - parseFloat(latdeg)),
                    lngf = Math.abs(lng - parseFloat(lngdeg)),
                    latmin = (latf * 60).toPrecision(5),
                    lngmin = (lngf * 60).toPrecision(5);
                var we = '', ns = '';
                
                if(a.latlng.lat>=0){
                    ns = 'N';
                }
                else{
                    ns = 'S';
                }
                
                if(a.latlng.wrap(-180, 180).lng>=0){
                    we = 'E';
                }
                else{
                    we = 'W';
                }
                
                window[a.type].innerHTML = latdeg.toString() + '° ' + latmin.toString() + "' " + ns + ', ' + lngdeg.toString() + '° ' + lngmin.toString() + "' " + we;
            });
            //Mouse position code ends
            //@@
            
            //tilelayer style variable
            var satellitegroup = L.layerGroup().addTo(map);
            
            var streetsgroup = L.layerGroup().addTo(map);
            
            var tilesatellite = L.mapbox.tileLayer("mapbox.streets-satellite");
            
            var tilestreet = L.mapbox.tileLayer("mapbox.streets");
            
            tilestreet.addTo(streetsgroup);
            
            
            var p = "";     //String variable for for the data path of the route
            
            var geo = "";   //Variable for geojson data path
            var gpx = "";   //Variable for gpx data path
            var csv = "";   //Variable for csv data path
            
            
            //Route geojson layergroup
            var geolayerGroup = L.layerGroup().addTo(map);
            
            //ECA geojson layergroup
            var ECAlayerGroup = L.layerGroup().addTo(map);
            
            //ECA geojson layer
            var ECAsNOxLayer = L.mapbox.featureLayer().loadURL("eca.geojson")
                                .on('ready', function(){
                                    this.setStyle({
                                        "color": "#ff5555",
                                        "weight": "2"
                                    })
                                }).addTo(ECAlayerGroup);
            
            ECAsNOxLayer.on('mouseover', function(){
                this.setStyle({
                    "color": "#ff0000",
                    "weight": "5"
                })
            });
            ECAsNOxLayer.on('mouseout', function(){
                this.setStyle({
                    "color": "#ff5555",
                    "weight": "2"
                })
            });
            
            //Function allows the selection showing on the map
            function createroute(){
                var route = document.getElementById("route");   

                geo = "GeoJSON/" + p + route.value;
                
                gpx = "GPX/" + p + route.value.replace('.geojson', '.gpx');
                csv = "CSV/" + p + route.value.replace('.geojson', '.csv');
                
                var geoLayer = L.mapbox.featureLayer()
                                .loadURL(geo)
                                .addTo(geolayerGroup);
                
                document.getElementById("GPX").disabled = false;
                document.getElementById("CSV").disabled = false;
    
                geoLayer.on('ready', function() {
                    map.fitBounds(geoLayer.getBounds());
                });
                
            };
         
            
            //Clear all route
            function clearroute(){
                geolayerGroup.clearLayers();
                map.setView([25.154, 121.377], 4);
                P = "";
                geo = "";
                gpx = "";
                csv = "";
                document.getElementById("GPX").disabled = true;
                document.getElementById("CSV").disabled = true;
                
                initial_line();
            };
            
        </script>
    </body>
</html>